version: '3.8'

services:
  zabbix-map-backend:
    image: node:18-alpine
    container_name: zabbix-backend
    restart: unless-stopped
    ports:
      - "23001:3000"  # üî• PUBLICA√á√ÉO EXPL√çCITA DA PORTA
    volumes:
      - ./backend:/app
    working_dir: /app
    command: >
      sh -c "
      cd /app &&
      npm init -y &&
      npm install express cors &&
      node server.js
      "
    environment:
      - NODE_ENV=production
      - PORT=3000
      - HOST=0.0.0.0
    networks:
      - zabbix-net
    healthcheck:  # üî• ADICIONAR HEALTHCHECK
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  zabbix-map-frontend:
    image: nginx:alpine
    container_name: zabbix-frontend
    restart: unless-stopped
    ports:
      - "23000:80"  # üî• PUBLICA√á√ÉO EXPL√çCITA DA PORTA
    volumes:
      - ./frontend:/usr/share/nginx/html:ro
    depends_on:
      zabbix-map-backend:
        condition: service_healthy  # üî• ESPERAR BACKEND SAUD√ÅVEL
    networks:
      - zabbix-net
    healthcheck:  # üî• ADICIONAR HEALTHCHECK
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  zabbix-net:
    driver: bridge
    name: zabbix-map-network  # üî• NOME EXPL√çCITO DA REDE
